# REFINE: Offline Reachability Analysis

## 1. Zonotope Reachable Sets Computation

**Note:** offline reachability analysis is achieved without the provided docker image being launched.

**Note:** all reachable sets are computed in **body frame**, i.e. the initial position and heading of the ego vehicle are 0.

REFINE utilizes 3 families of desired trajectories that are observed during daily driving to achieve *speed change*, *direction change* and *lane change*. 
Each desired trajectory is parametrized by control parameter $p = [p_u, p_y]^\top$ where $p_u$ denotes desired longitudinal speed and $p_y$ decides desired lateral displacement. 
To perform offline reachability analysis using such desired trajectories:

- Run [`space_subdivision.m`](https://github.com/roahmlab/REFINE/blob/main/Offline_Reachability_Analysis/space_subdivision.m) to compute subdivision of the initial longitudinal velocity space and contrl parameter space for simulation on a full-size Front-Wheel-Drive vehicle. Change `isSim` to `0` for All-Wheel-Drive racecar robot. 

- Run [`vehicle_dynamics_generation.m`](https://github.com/roahmlab/REFINE/blob/main/Offline_Reachability_Analysis/vehicle_dynamics_generation.m)
to generate closed-loop vehicle dynamics with proposed controller over 3 families of desired trajectories.

- Run [`FRS_computation_speed_change.m`](https://github.com/roahmlab/REFINE/blob/main/Offline_Reachability_Analysis/FRS_computation_speed_change.m) to compute FRS for speed change maneuvers.

- Run [`FRS_computation_direction_change.m`](https://github.com/roahmlab/REFINE/blob/main/Offline_Reachability_Analysis/FRS_computation_direction_change.m) to compute FRS for direction change maneuvers.

- Run [`FRS_computation_lane_change.m`](https://github.com/roahmlab/REFINE/blob/main/Offline_Reachability_Analysis/FRS_computation_lane_change.m) to compute FRS for lane change maneuvers.

- Run [`wrap_up_FRS.m`](https://github.com/roahmlab/REFINE/blob/main/Offline_Reachability_Analysis/wrap_up_FRS.m) to wrap up all computed FRS and necessary information as a map container that is used for online planning.
Resulted map container is provided as [`car_frs.mat`](https://drive.google.com/drive/folders/1WZbFFhCyhYQlMJxuV4caIzNoa-Q9VZkW?usp=sharing).

## 2. Data Structure

Recall our zonotope reachable sets are generated by first partitioning both spaces of initial longitudinal velocity $u_0$ and control parameter $p = [p_u, p_y]^\top$, then performing reachability analysis over each partition element. 

### 2.1 Partition on the Space of Initial Longitudinal Velocity

Partition information of $u_0$ is saved in [`***_change_Ay_info`](https://drive.google.com/drive/folders/1WZbFFhCyhYQlMJxuV4caIzNoa-Q9VZkW?usp=sharing) generated by [`space_subdivision.m`](https://github.com/roahmlab/REFINE/blob/main/Offline_Reachability_Analysis/space_subdivision.m).
The $i$-th partition element of $u_0$ can be represented as `[u0_vec(i) - u0_gen, u0_vec(i) + u0_gen]`.

### 2.2 Partition on the Space of Control Parameter

Partition on the space of $p_u$ is identical to that of $u_0$. 
Suppose the initial longitudinal velocity $u_0$ starts in the $i$-th partition element `[u0_vec(i) - u0_gen, u0_vec(i) + u0_gen]`, then the related partition elements on $p_y$ of both direction and lane change maneuvers can be represented as `[-Ay_vec(i), -0.5 * Ay_vec(i)]`, `[-0.5 * Ay_vec(i), 0]`, `[0, 0.5 * Ay_vec(i)]` and `[0.5 * Ay_vec(i), Ay_vec(i)]` where `Ay_vec` is saved in [`dir_change_Ay_info`](https://drive.google.com/drive/folders/1WZbFFhCyhYQlMJxuV4caIzNoa-Q9VZkW?usp=sharing) and [`lane_change_Ay_info`](https://drive.google.com/drive/folders/1WZbFFhCyhYQlMJxuV4caIzNoa-Q9VZkW?usp=sharing) respectively. 

**Note:** for computational efficiency we only perform reachability analysis over the 3rd and 4th partition elements on $p_y$ for direction and lane change maneuvers, and the reachable sets for the 1st and 2nd partition elements can be simplily generated by negating the sign of information on dimension y in the reachable sets of the 4th and 3rd partition elements respectively due to the symmetry of the ego vehicle. 


### 2.3 Reachability Analysis Information in `car_frs.mat`

`car_frs.mat` wraps up reachability analysis results of the ego vehicle's tracking performance for all 3 families of desired trajectories. 
Suppose the initial longitudinal velocity $u_0$ starts in the $i$-th partition element `[u0_vec(i) - u0_gen, u0_vec(i) + u0_gen]`, then the result of reachability analysis  of a particular partition element on the space of $p$ can be obtained as:
- *Speed change maneuver:* (the $j$-th partition element on the space of $p_u$)
```
submap = M_mega{i}('Au');
reachability_info = submap{j};
```
- *Direction change maneuver:* (the $(j+2)$-th partition element on the space of $p_y$)
```
submap = M_mega{i}('dir');
reachability_info = submap{j};
```
- *Lane change maneuver:* (the $(j+2)$-th partition element on the space of $p_y$)
```
submap = M_mega{i}('lan');
reachability_info = submap{j};
```
where `M_mega` is saved in `car_frs.mat`.

Recall each desired trajectory is appended by a contingency braking maneuver for safety concern, then the reachability analysis result `reachability_info` is saved as a struct that contains 3 fields:
- *vehRS_save:* an array of cell where each cell contains a zonotope reachable set over some time interval. Details of the zonotope reachable set are provided in [2.4 Zonotope Reachable Sets](#24-zonotope-reachable-sets).
- *brake_idx1:* the index of a zonotope reachable set such that the contingency braking maneuver starts its execution within the corresponding time interval of `reachability_info.vehRS_save{brake_idx1}`.
- *brake_idx2:* the index of a zonotope reachable set such that the guard from high-speed vehicle model to low-speed vehicle model is triggered within the corresponding time interval of `reachability_info.vehRS_save{brake_idx2}`, while the contingency braking maneuver is being executed.

### 2.4 Zonotope Reachable Sets

Each zonotope reachable set `Z` saved in `reachability_info.vehRS_save` is a 20-dimensional zonotope that over-approximates the ego vehicle's behavior over some time interval `t_interval`. 
Meanings of all 20 dimensions in `Z` are listed as follows (see [`vehicle_dynamics_generation.m`](https://github.com/roahmlab/REFINE/blob/main/Offline_Reachability_Analysis/vehicle_dynamics_generation.m) for details):
- dimension 1: vehicle position along $x$-axis of the world frame;
- dimension 2: vehicle position along $y$-axis of the world frame;
- dimension 3: vehicle heading $h$;
- dimension 4: vehicle longitudinal velocity $u$ in the body frame;
- dimension 5: vehicle lateral velocity $v$ in the body frame;
- dimension 6: vehicle yaw rate $r$;
- dimension 7: initial longitudinal velocity $u_0$ (**sliceable**);
- dimension 8: initial lateral velocity $v_0$ (**sliceable**);
- dimension 9: initial yaw rate $r_0$ (**sliceable**);
- dimension 10: auxiliary state to help tracking the starting time of a driving maneuver;
- dimension 11: control parameter $p_u$ (**sliceable when applying a speed change maneuver**);
- dimension 12: control parameter $p_y$ (**sliceable when applying a direction/lane change maneuver**);
- dimension 13 ~ 19: auxiliarty states for the computation of proposed robust partial feedback linearization controller during reachability analysis;
- dimension 20: time $t$.

Such time interval can be computed as follows:
```
Z = reachability_info.vehRS_save{some_index};
Z_interval = interval(Z);
t_interval = Z_interval(20);
```



